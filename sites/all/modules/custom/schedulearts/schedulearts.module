<?php

/**
 * Implements hook_views_api().
 */
function schedulearts_views_api() {
  return array(
    'api' => 3,
  );
}

/**
 * Implements hook_node_validate().
 */
function schedulearts_node_validate($node, $form) {
}

/**
 * Implements hook_flag_link().
 *
 * When Flag uses a link type provided by this module, it will call this
 * implementation of hook_flag_link(). It returns a single link's attributes,
 * using the same structure as hook_link(). Note that "title" is provided by
 * the Flag configuration if not specified here.
 *
 * @param $flag
 *   The full flag object of for the flag link being generated.
 * @param $action
 *   The action this link will perform. Either 'flag' or 'unflag'.
 * @param $content_id
 *   The ID of the node, comment, user, or other object being flagged.
 * @return
 *   An array defining properties of the link.
 */
function schedulearts_flag($action, $flag, $content_id, $account) {
  if ($action == 'flag' && $flag->name == 'schedule_approved') {
    // Send email to group members
    $node = node_load($content_id);
    if (isset($node->field_sched_groups['und'])) {
      foreach ($node->field_sched_groups['und'] as $term_entry ) {
        $tid_array[] = $term_entry['tid'];
      }
      $tid_string = implode(',', $tid_array); 
      $users = db_query('SELECT DISTINCT users.uid AS uid 
        FROM users 
        INNER JOIN field_data_field_user_groups 
        ON users.uid = field_data_field_user_groups.entity_id 
        AND field_data_field_user_groups.entity_type = \'user\' 
        WHERE (( field_data_field_user_groups.field_user_groups_tid IN ( :tid )  ))', array(':tid' => $tid_string));
      foreach ($users as $user) {
        $userfields = reset(entity_load('user', array($user->uid)));
        // Build the view
        $allowed_tags = array('a', 'em', 'i', 'strong', 'b', 'br', 'p', 'blockquote', 'ul', 'ol', 'li', 'dl', 'dt', 'dd', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'hr');
        $view = views_get_view('taxonomy_term_calendar' , TRUE);
        $arg[] = $node->field_sched_date['und']['0'];
        $arg[] = $userfields->uid;
        $views_result = $view->preview('page_2', $arg);
        $sched_view_output = drupal_html_to_text($views_result, $allowed_tags);

        $sched_from = variable_get('system_mail', 'info@schedulearts.com');
        $sched_to = $userfields->mail;
        $sched_to_name = $userfields->name;
        $sched_daterng = $node->field_sched_date['und']['0']['value'] . ' - ' . $node->field_sched_date['und']['0']['value2'];
        $sched_subj = 'Your personal schedule for ' . $sched_daterng;
        if ($node->body['und']) $sched_note = $node->body['und']['0']['value'];
        $sched_body = "Dear $sched_to_name,
      
  $sched_note 

  Here is your schedule for the period $sched_daterng. You can see this in a friendlier format online at: 
          
        $GLOBALS[base_url]/user/$user->uid/mycal
          
          
  *** MY SCHEDULE FOR $sched_daterng ***
  $sched_view_output

  Thanks!";


        $mailtoken = microtime();
        $mailid = 'schedulearts' . '_' . $mailtoken;
        $message = array(
          'id' => $mailid,
          'to' => $sched_to,
          'subject' => $sched_subj,
          'body' => array($sched_body),
          'headers' => array(
            'From' => $sched_from,
            'Sender' => $sched_from,
            'Return-Path' => $sched_from
          ),
        );
        $system = drupal_mail_system('schedulearts', $mailtoken);
        $message = $system->format($message);

        if ($system->mail($message)) {
        }
      }
    }
  }
}

/*
 * Implements hook_form_alter().
 */

function schedulearts_form_alter(&$form, &$form_state, $form_id) {
  // tweaks to user-groups View

  // make the search field bigger
  if($form_id == 'views_exposed_form') {
    $form['field_user_searchable_name_value']['#size'] = 60;
  }
  // Set the order of VBO options 
  if($form_id == 'views_form_user_groups_page') {
    $form['select']['operation']['#options'] = array(
      '0' => '- Choose an operation -',
      'action::views_bulk_operations_modify_action' => 'Add to Groups',
      'rules_component::rules_promote_to_company_administrator' => 'Promote to company admin',
      'rules_component::rules_demote_from_company_administrator' => 'Demote from company admin',
      'action::user_block_user_action' => 'De-Activate',
      'rules_component::rules_unblock_a_user' => 'Activate',
      'action::views_bulk_operations_delete_item' => 'Delete',
    );
  }

  // Tweaks to the Call people interface
  if ($form_id == 'call_node_form')  {
    // Set the parent event from POST, and make the field unavailable for input
    $form['field_call_parent_event']['und']['#disabled'] = TRUE;
    if (!$form['nid']['#value']) {
      $form['field_call_parent_event']['und']['#default_value'] = $_POST['edit']['field_call_parent_event']['und'];
    }
    // Get the parent event object
    $parent_event = reset(entity_load('node', array($form['field_call_parent_event']['und']['#default_value'])));

    // Set the default dates
    $form['field_event_date']['und']['0']['#default_value']['value'] = $parent_event->field_event_date['und']['0']['value'];
    $form['field_event_date']['und']['0']['#default_value']['value2'] = $parent_event->field_event_date['und']['0']['value2'];

    // Limit available options in the dropdowns
    $form_state['#schedulearts']['parent_event'] = $parent_event;
    $form_state['#schedulearts']['min_date'] = $parent_event->field_event_date['und']['0']['value'];
    $form_state['#schedulearts']['max_date'] = $parent_event->field_event_date['und']['0']['value2'];
    $form['field_event_date']['#after_build'][] = 'schedulearts_call_date_limit';
  }
}

/*
 * Limit select options in field_event_date on Call node forms
 */

function schedulearts_call_date_limit($form_element, &$form_state) {
//  dpm($form_state);
//  dpm($form_element);
  $min_date = new DateObject($form_state['#schedulearts']['min_date']);
  $max_date = new DateObject($form_state['#schedulearts']['max_date']);

  // Set fixed date, since all events occur on a single day
  $form_element['und']['0']['value']['year']['#options'] = array(date_format_date($min_date, 'custom', 'Y') => date_format_date($min_date, 'custom', 'Y'));
  $form_element['und']['0']['value']['month']['#options'] = array(date_format_date($min_date, 'custom', 'M') => date_format_date($min_date, 'custom', 'M'));
  $form_element['und']['0']['value']['day']['#options'] = array(date_format_date($min_date, 'custom', 'j') => date_format_date($min_date, 'custom', 'j'));
  $form_element['und']['0']['value2']['year']['#options'] = array(date_format_date($min_date, 'custom', 'Y') => date_format_date($max_date, 'custom', 'Y'));
  $form_element['und']['0']['value2']['month']['#options'] = array(date_format_date($min_date, 'custom', 'M') => date_format_date($max_date, 'custom', 'M'));
  $form_element['und']['0']['value2']['day']['#options'] = array(date_format_date($min_date, 'custom', 'j') => date_format_date($max_date, 'custom', 'j'));

  return $form_element;
}
